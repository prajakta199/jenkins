pipeline {
  agent any

  tools {
    nodejs "node"
  }

 parameters {
  choice(
    name: 'BROWSER',
    choices: ['chrome', 'edge', 'all'],
    description: 'Choose the browser to run tests on (based on defined Playwright projects)'
  )
}

  stages {
    stage('Install Dependencies') {
      steps {
        sh 'npm install'
        sh 'npx playwright install --with-deps'
      }
    }


    stage('Run Tests on BrowserStack') {
      steps {
        browserstack(credentialsId: 'ce17c56d-ea58-4b36-84cf-8532bbbc6e03') {
          script {
            def project = getProjectToRun(params.BROWSER)
            def command = "npx browserstack-node-sdk playwright test --config=./playwright.local.config.js ${project}"
            echo "Running: ${command}"
            sh command
          }
        }
      }
    }
  }
}
def getProjectToRun(String browser) {
  switch (browser) {
    case "chrome":
      return "'--project=osx_big_sur_chrome'"
    case "edge":
      return "'--project=win10_edge'"
    case "all":
      return "'--project=osx_big_sur_chrome,win10_edge'"
    default:
      error "Unknown browser specified: ${browser}"
  }
}
